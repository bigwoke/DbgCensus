@using DbgCensus.Rest.Abstractions.Queries
@using DbgCensus.Rest.Abstractions

@page "/"
@inject IJSRuntime JSRuntime
@inject ICensusRestClient CensusRestClient
@inject IQueryBuilderFactory QueryFactory

<h1>Query Online Outfit Members</h1>



<CopyToClipboard Text="@_queryStringOne" />

<h1>Query String Two</h1>

<CopyToClipboard Text="@_queryStringTwo" />

<h1>Join String</h1>

<CopyToClipboard Text="@_joinString" />

<h1>Online Outfit Members Query String</h1>

<CopyToClipboard Text="@_onlineOutfitMembersString" />

<SurveyPrompt Title="How is Blazor working for you?" />

@code {
    private string _queryStringOne;
    private string _queryStringTwo;
    private string _joinString;
    private string _onlineOutfitMembersString;

    protected override void OnInitialized()
    {
        _queryStringOne = QueryFactory.Get()
            .OnCollection("outfit")
            .Where("alias_lower", SearchModifier.Equals, "uvoc")
            .AddResolve("leader", "name")
            .AddResolve("member_online_status")
            .HasFields("name_lower")
            .HideFields("name")
            .ConstructEndpoint().AbsoluteUri;

        _queryStringTwo = QueryFactory.Get()
            .OnCollection("outfit")
            .Where("member_count", SearchModifier.GreaterThan, 100)
            .WithSortOrder("member_count", SortOrder.Ascending)
            .WithSortOrder("name_lower", SortOrder.Ascending)
            .WithLimit(10)
            .WithTimings()
            .WithStartIndex(9)
            .ConstructEndpoint().AbsoluteUri;

        IJoinBuilder join = QueryFactory.Get().AddJoin("outfit").IsList().InjectAt("injectedHere").HideFields("show1", "show2");

        join.AddNestedJoin("character").Where("name", SearchModifier.Equals, "Falcon");
        join.AddNestedJoin("item").OnField("item_id");

        _joinString = join.ToString();

        _onlineOutfitMembersString = QueryFactory.Get()
            .OnCollection("outfit")
            .Where("alias_lower", SearchModifier.Equals, "uvoc")
            .ShowFields("name", "outfit_id", "alias")
            .AddJoin("outfit_member", (membersJoin) =>
            {
                membersJoin.InjectAt("members")
                    .ShowFields("character_id")
                    .IsList()
                    .AddNestedJoin("character", (charactersJoin) =>
                    {
                        charactersJoin.OnField("character_id")
                            .InjectAt("character")
                            .ShowFields("name.first")
                            .IsInnerJoin()
                            .AddNestedJoin("characters_online_status", (onlineJoin) =>
                            {
                                onlineJoin.InjectAt("online_status")
                                    .ShowFields("online_status")
                                    .IsInnerJoin()
                                    .AddNestedJoin("world", (worldJoin) =>
                                    {
                                        worldJoin.OnField("online_status")
                                            .ToField("world_id")
                                            .InjectAt("ignore_this")
                                            .ShowFields("world_id")
                                            .IsInnerJoin();
                                    });
                            });
                    });
            })
            .ConstructEndpoint().AbsoluteUri;
    }
}
